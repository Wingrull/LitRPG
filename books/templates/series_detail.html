<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ series.title }} - Библиотека LitRPG</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        img { max-width: 200px; height: auto; margin-bottom: 10px; }
        .book-img { max-width: 80px; height: auto; vertical-align: middle; margin-right: 10px; }
        ul { list-style-type: none; padding: 0; }
        li { margin: 10px 0; }
        .auth-links { position: absolute; top: 20px; right: 20px; }
        .auth-links a { margin-left: 10px; }
        .status-form { margin: 10px 0; }
    </style>
</head>
<body>
    {% load custom_filters %}
    <div class="auth-links">
        {% if user.is_authenticated %}
            <span>Привет, {{ user.username }}!</span>
            <a href="{% url 'logout' %}">Выйти</a>
        {% else %}
            <a href="{% url 'login' %}">Войти</a>
            <a href="{% url 'register' %}">Регистрация</a>
        {% endif %}
    </div>
    <h1>{{ series.title }} by {{ series.author }}</h1>
    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    {% if series.cover_image %}
        <img src="data:{{ series.cover_content_type }};base64,{{ series.cover_image | b64encode }}" alt="{{ series.title }} обложка">
    {% endif %}
    <p>{{ series.description }}</p>
    {% if series.genres.exists %}
        <p>Жанры: {% for genre in series.genres.all %}{{ genre.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
    {% else %}
        <p>Жанры: Нет жанров</p>
    {% endif %}
    <p>Книг: {{ series.book_count }} | Рейтинг: {{ series.average_rating|default:"Нет рейтинга" }} |
       {{ series.is_completed|yesno:"Завершена,Не завершена" }}</p>
    <p>Добавлена: {{ series.added_at }}</p>
    {% if user.is_authenticated %}
        <div class="status-form">
            <form method="post" action="{% url 'set_series_status' series.id %}">
                {% csrf_token %}
                <label>Статус серии:</label>
                <select name="status">
                    <option value="READ" {% if user_status == 'READ' %}selected{% endif %}>Прочитано</option>
                    <option value="PARTIAL" {% if user_status == 'PARTIAL' %}selected{% endif %}>Не дочитал</option>
                    <option value="UNREAD" {% if user_status == 'UNREAD' or not user_status %}selected{% endif %}>Не прочитано</option>
                </select>
                <button type="submit">Сохранить</button>
            </form>
        </div>
    {% endif %}

    <h2>Книги</h2>
    <ul>
        {% for book in series.books.all %}
            <li>
                {% if book.cover_image %}
                    <img class="book-img" src="data:{{ book.cover_content_type }};base64,{{ book.cover_image | b64encode }}" alt="{{ book.title }} обложка">
                {% endif %}
                {{ book.title }} (№{{ book.order_in_series }}) - {{ book.publication_year }}
            </li>
        {% empty %}
            <li>Книги отсутствуют</li>
        {% endfor %}
    </ul>

    <h2>Отзывы</h2>
    <ul>
        {% for review in series.reviews.all %}
            <li>{{ review.text }} ({{ review.user.username }})</li>
        {% empty %}
            <li>Отзывы отсутствуют</li>
        {% endfor %}
    </ul>

    <a href="{% url 'series_list' %}">Назад к списку серий</a>
</body>
</html>